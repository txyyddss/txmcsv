name: Create Release

on:
  workflow_dispatch:    # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥ä¾¿è·å–ä¸Šä¸€ä¸ª release
      
      - name: Clean plugins directory
        run: |
          if [ -d "./plugins" ]; then
            find ./plugins -type f -not \( -name "*.yml" -o -name "*.conf" -o -name "*.txt" -o -name "*.jar" \) -delete
          fi
      
      - name: Create release zip
        run: |
          zip -r release.zip . -x "README.md" ".github/*" ".gitattributes"
      
      - name: Generate changelog
        id: changelog
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è·å–æœ€æ–° release çš„æ—¥æœŸ
          LAST_RELEASE=$(gh release list --limit 1)
          if [ -n "$LAST_RELEASE" ]; then
            LAST_RELEASE_DATE=$(echo "$LAST_RELEASE" | awk '{print $3}')
            echo "Last release date: $LAST_RELEASE_DATE"
          else
            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¸Šä¸€ä¸ª releaseï¼Œä½¿ç”¨ä¸€ä¸ªè¾ƒæ—©çš„æ—¥æœŸ
            LAST_RELEASE_DATE="1970-01-01"
            echo "No previous release found, using date: $LAST_RELEASE_DATE"
          fi
          
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å­˜å‚¨ bug fixes å’Œ features
          > bug_fixes.txt
          > features.txt
          
          # è·å–ä»ä¸Šä¸€ä¸ª release ä»¥æ¥å…³é—­çš„ issues
          # æ’é™¤æ ‡è®°ä¸º "Closed as not planned" çš„ issues
          ISSUES=$(gh issue list --state closed --search "closed:>$LAST_RELEASE_DATE -label:\"Closed as not planned\"" --json number,title,labels --limit 100)
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ issues
          if [ -z "$ISSUES" ] || [ "$ISSUES" == "[]" ]; then
            echo "No issues found since last release"
          else
            # ä½¿ç”¨ jq ä¸€æ¬¡æ€§å¤„ç†æ‰€æœ‰ issuesï¼Œé¿å…åœ¨å¾ªç¯ä¸­å¤„ç†
            echo "$ISSUES" | jq -r '.[] | select(.labels | map(.name | ascii_downcase) | any(contains("bug"))) | "ä¿®å¤äº†\(.title)çš„é—®é¢˜ #\(.number)"' > bug_fixes.txt
            echo "$ISSUES" | jq -r '.[] | select(.labels | map(.name | ascii_downcase) | any(contains("feature") or contains("enhancement"))) | "\(.title) #\(.number)"' > features.txt
          fi
          
          # åˆ›å»º changelog
          echo "# ğŸ“¦ æ›´æ–°å†…å®¹ï¼š" > changelog.md
          echo "## Bugä¿®å¤" >> changelog.md
          if [ -s bug_fixes.txt ]; then
            cat bug_fixes.txt >> changelog.md
          fi
          
          echo "" >> changelog.md
          echo "## åŠŸèƒ½æ›´æ”¹" >> changelog.md
          if [ -s features.txt ]; then
            cat features.txt >> changelog.md
          fi
          
          # æ˜¾ç¤ºç”Ÿæˆçš„ changelog
          cat changelog.md
      
      - name: Create Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ç”Ÿæˆæ—¥æœŸæ ¼å¼çš„ tag
          TAG=$(date +'%Y.%m.%d')
          
          # åˆ›å»º release
          gh release create "$TAG" \
            --title "$TAG" \
            --notes-file changelog.md \
            release.zip