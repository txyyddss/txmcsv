name: Auto Release Pipeline

on:
  workflow_dispatch:

jobs:
  build-release:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # ...ä¿æŒå…¶ä»–æ­¥éª¤ä¸å˜...

    - name: Get previous release date
      id: previous-release
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # å¤„ç†é¦–æ¬¡å‘å¸ƒçš„æƒ…å†µ
        if ! gh release view latest &>/dev/null; then
          echo "æ²¡æœ‰æ‰¾åˆ°å†å²ç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤æ—¥æœŸ"
          echo "date=1970-01-01T00:00:00Z" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        latest_date=$(gh api repos/${{ github.repository }}/releases/latest \
          --jq '.created_at' \
          --silent \
          --cache 60)
        echo "date=${latest_date}" >> $GITHUB_OUTPUT

    - name: Generate changelog
      id: changelog
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # URLç¼–ç æ—¥æœŸå‚æ•°
        encoded_date=$(echo "${{ steps.previous-release.outputs.date }}" | jq -sRr @uri)
        
        # ä½¿ç”¨æ›´å¥å£®çš„APIæŸ¥è¯¢æ–¹å¼
        issues=$(gh api "repos/${{ github.repository }}/issues?state=closed&since=${encoded_date}" \
          --jq '[.[] | select(any(.labels[]?; .name != "Closed as not planned"))]' \
          --cache 60s)
        
        # æ„å»ºå˜æ›´æ—¥å¿—å†…å®¹
        changelog_content="ğŸ“¦ æ›´æ–°å†…å®¹ï¼š\n"
        
        if [ $(echo "$issues" | jq 'length > 0') == "true" ]; then
          echo "$issues" | jq -r '.[].title' | while IFS= read -r title; do
            changelog_content+="â€¢ ä¿®å¤äº†ã€Œ${title}ã€çš„é—®é¢˜\n"
          done
        else
          changelog_content+="â€¢ æœ¬æ¬¡æ›´æ–°åŒ…å«å¸¸è§„ç»´æŠ¤å’Œä¼˜åŒ–"
        fi

        # ä½¿ç”¨heredocæ ¼å¼è¾“å‡º
        delimiter=$(openssl rand -hex 16)
        echo "log<<${delimiter}" >> $GITHUB_OUTPUT
        echo -e "$changelog_content" >> $GITHUB_OUTPUT
        echo "${delimiter}" >> $GITHUB_OUTPUT
