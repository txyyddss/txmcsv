name: Create Release with Changelog

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ÁâàÊú¨Âè∑'
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. Ê£ÄÂá∫‰ª£Á†Å
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Ëé∑ÂèñÂÆåÊï¥ÂéÜÂè≤‰ª•‰æøÊ≠£Á°ÆÂ§ÑÁêÜissues

      # 2. ÊõøÊç¢ÁâàÊú¨Âè∑
      - name: Update version in files
        run: |
          # ÊõøÊç¢globalscoreboard.yml‰∏≠ÁöÑÁâàÊú¨Âè∑
          if [ -f "./plugins/AnimatedScoreboard/scoreboards/globalscoreboard.yml" ]; then
            sed -i "s/%server_version%/${{ github.event.inputs.version }}/g" "./plugins/AnimatedScoreboard/scoreboards/globalscoreboard.yml"
          fi
          
          # ÊõøÊç¢globalnoseason.yml‰∏≠ÁöÑÁâàÊú¨Âè∑
          if [ -f "./plugins/AnimatedScoreboard/scoreboards/globalnoseason.yml" ]; then
            sed -i "s/%server_version%/${{ github.event.inputs.version }}/g" "./plugins/AnimatedScoreboard/scoreboards/globalnoseason.yml"
          fi

      # 3. Ê∏ÖÁêÜpluginsÁõÆÂΩï - Âè™‰øùÁïô.yml,.conf,.txt,.jarÊñá‰ª∂ÂíåÊâÄÊúâÊñá‰ª∂Â§πÁªìÊûÑ
      - name: Clean plugins directory
        run: |
          if [ -d "./plugins" ]; then
            find ./plugins -type f -not \( -name "*.yml" -o -name "*.conf" -o -name "*.txt" -o -name "*.jar" \) -delete
          fi

      # 4. ÊâìÂåÖÊñá‰ª∂
      - name: Create update package
        run: |
          # ÂÆâË£Ö7z
          sudo apt-get update
          sudo apt-get install -y p7zip-full
          
          # ÂàõÂª∫ÊéíÈô§Êñá‰ª∂ÂàóË°®
          echo "README.md" > exclude.txt
          echo ".github/" >> exclude.txt
          echo ".git/" >> exclude.txt
          echo ".gitattributes" >> exclude.txt
          echo "manual.txt" >> exclude.txt
          
          # ‰ΩøÁî®7zÂàõÂª∫ÂéãÁº©ÂåÖÔºå‰ΩøÁî®ÊúÄÈ´òÂéãÁº©Á∫ßÂà´
          7z a -t7z -mx=9 -xr@exclude.txt update_pack.7z ./

      # 5. ÁîüÊàêÊõ¥Êñ∞Êó•Âøó
      - name: Generate changelog
        id: changelog
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // Ëé∑ÂèñÊúÄÊñ∞ÁöÑrelease
            let latestRelease;
            try {
              latestRelease = await github.rest.repos.getLatestRelease({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
            } catch (error) {
              console.log("No previous releases found, will include all issues");
            }
            
            // ËÆæÁΩÆÊü•ËØ¢ÂèÇÊï∞
            const query = latestRelease 
              ? `repo:${context.repo.owner}/${context.repo.repo} is:issue is:closed state:closed closed:>${latestRelease.data.created_at}`
              : `repo:${context.repo.owner}/${context.repo.repo} is:issue is:closed state:closed`;
            
            // ÊêúÁ¥¢Á¨¶ÂêàÊù°‰ª∂ÁöÑissues
            const result = await github.rest.search.issuesAndPullRequests({
              q: query,
              per_page: 100
            });
            
            const issues = result.data.items.filter(issue => {
              // ÊéíÈô§Ê†áËÆ∞‰∏∫wontfixÊàñinvalidÁöÑissue
              const labels = issue.labels.map(label => label.name.toLowerCase());
              return !labels.includes('wontfix') && !labels.includes('invalid');
            });
            
            // ÂàÜÁ±ªissues
            const bugfixes = [];
            const features = [];
            
            for (const issue of issues) {
              const title = issue.title
                .replace('[Bug]: ', '')
                .replace('[Bug]:', '')
                .replace('[Feature request]: ', '')
                .replace('[Feature request]:', '')
                .trim();
                
              if (issue.title.toLowerCase().includes('[bug]')) {
                bugfixes.push({ title, number: issue.number });
              } else if (issue.title.toLowerCase().includes('[feature')) {
                features.push({ title, number: issue.number });
              }
            }
            
            // ËØªÂèñmanual.txt
            let manualContent = '';
            try {
              if (fs.existsSync('manual.txt')) {
                manualContent = fs.readFileSync('manual.txt', 'utf8');
              }
            } catch (error) {
              console.log('No manual.txt found or error reading it:', error);
            }
            
            // ÁîüÊàêchangelogÂÜÖÂÆπ
            let changelog = '# üì¶ Êõ¥Êñ∞ÂÜÖÂÆπÔºö\n\n';
            
            if (manualContent) {
              changelog += '## ÊâãÂä®Êõ¥Êîπ\n' + manualContent + '\n\n';
            } else {
              changelog += '## ÊâãÂä®Êõ¥Êîπ\n\n';
            }
            
            changelog += '## Bug‰øÆÂ§ç\n';
            if (bugfixes.length > 0) {
              for (const bug of bugfixes) {
                changelog += `‰øÆÂ§ç‰∫Ü${bug.title}ÁöÑÈóÆÈ¢ò #${bug.number}\n`;
              }
            }
            changelog += '\n';
            
            changelog += '## ÂäüËÉΩÊõ¥Êîπ\n';
            if (features.length > 0) {
              for (const feature of features) {
                changelog += `${feature.title} #${feature.number}\n`;
              }
            }
            
            // ‰øùÂ≠òÂà∞Êñá‰ª∂
            fs.writeFileSync('CHANGELOG.md', changelog);
            
            return changelog;

      # 6. ÂàõÂª∫release
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ format('{0}_{1}', formatDate(fromJSON('{"year":"numeric","month":"2-digit","day":"2-digit"}'), 'yyyy.MM.dd'), github.event.inputs.version) }}
          name: ${{ format('{0}_{1}', formatDate(fromJSON('{"year":"numeric","month":"2-digit","day":"2-digit"}'), 'yyyy.MM.dd'), github.event.inputs.version) }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: false
          files: |
            update_pack.7z