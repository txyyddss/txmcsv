name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·'
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥ä¾¿åç»­è·å–ä¸Šæ¬¡releaseä¿¡æ¯

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯
        run: |
          sed -i "s/%server_version%/${{ github.event.inputs.version }}/g" ./plugins/AnimatedScoreboard/scoreboards/globalscoreboard.yml
          echo "ç‰ˆæœ¬å·å·²æ›´æ–°ä¸º ${{ github.event.inputs.version }}"

      - name: æ¸…ç†æ’ä»¶æ–‡ä»¶å¤¹
        run: |
          find ./plugins -type f \
            ! -name "*.yml" \
            ! -name "*.conf" \
            ! -name "*.txt" \
            ! -name "*.jar" \
            -delete
          echo "å·²åˆ é™¤ä¸éœ€è¦çš„æ–‡ä»¶ï¼Œä¿ç•™æ–‡ä»¶å¤¹ç»“æ„"

      - name: åˆ›å»ºæ›´æ–°åŒ…
        run: |
          zip -r update_pack.zip . \
            -x "*.git*" \
            -x ".github/*" \
            -x "README.md" \
            -x ".gitattributes"
          echo "update_pack.zip å·²åˆ›å»º"

      - name: è·å–ä¸Šæ¬¡å‘å¸ƒçš„æ ‡ç­¾
        id: last_release
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            echo "LAST_TAG=none" >> $GITHUB_ENV
          else
            echo "LAST_TAG=$LAST_TAG" >> $GITHUB_ENV
          fi
          echo "ä¸Šæ¬¡å‘å¸ƒæ ‡ç­¾: ${LAST_TAG:-æ— }"

      - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
        id: changelog
        run: |
          echo "# ğŸ“¦ æ›´æ–°å†…å®¹ï¼š" > changelog.md
          
          # æ·»åŠ æ‰‹åŠ¨æ›´æ”¹éƒ¨åˆ†
          echo -e "\n## æ‰‹åŠ¨æ›´æ”¹" >> changelog.md
          if [ -f "manual.txt" ]; then
            cat manual.txt >> changelog.md
          else
            echo "æ— æ‰‹åŠ¨æ›´æ”¹" >> changelog.md
          fi
          
          # ä½¿ç”¨Pythonè„šæœ¬å¤„ç†issueså¹¶ç”Ÿæˆchangelog
          python - << 'EOF' >> $GITHUB_ENV
          import os
          import json
          import subprocess
          import datetime
          
          # è·å–issues
          query_command = [
            'gh', 'api', '--paginate',
            '/repos/${{ github.repository }}/issues',
            '-q', '[.[] | select(.state == "closed" and .pull_request == null and (.labels | map(.name) | contains(["wontfix", "invalid"]) | not))]'
          ]
          
          last_tag = os.environ.get('LAST_TAG', 'none')
          
          if last_tag != 'none':
            # è·å–ä¸Šæ¬¡releaseæ—¥æœŸ
            date_command = ['gh', 'api', '/repos/${{ github.repository }}/releases/tags/' + last_tag, '-q', '.created_at']
            try:
              last_release_date = subprocess.check_output(date_command, text=True).strip()
            except:
              last_release_date = None
              
            if last_release_date:
              query_command[3] += '?since=' + last_release_date
          
          try:
            issues_json = subprocess.check_output(query_command, text=True)
            issues = json.loads(issues_json) if issues_json.strip() else []
          except Exception as e:
            issues = []
            with open('changelog.md', 'a') as f:
              f.write(f"\nè·å–issuesæ—¶å‡ºé”™: {str(e)}\n")
          
          # åˆ†ç±»issues
          bugs = []
          features = []
          
          for issue in issues:
            if not any(label['name'] in ['wontfix', 'invalid'] for label in issue.get('labels', [])):
              title = issue['title']
              number = issue['number']
              
              # ç§»é™¤å‰ç¼€
              if title.startswith('[Bug]: '):
                title = title[7:].strip()
                bugs.append((title, number))
              elif title.startswith('[Feature request]: '):
                title = title[19:].strip()
                features.append((title, number))
              elif any(label['name'].lower() == 'bug' for label in issue.get('labels', [])):
                bugs.append((title, number))
              elif any(label['name'].lower() in ['enhancement', 'feature'] for label in issue.get('labels', [])):
                features.append((title, number))
          
          # å°†ç»“æœå†™å…¥changelog
          with open('changelog.md', 'a') as f:
            f.write("\n## Bugä¿®å¤\n")
            if bugs:
              for title, number in bugs:
                f.write(f"ä¿®å¤äº†{title}çš„é—®é¢˜ #{number}\n")
            else:
              f.write("æ— Bugä¿®å¤\n")
            
            f.write("\n## åŠŸèƒ½æ›´æ”¹\n")
            if features:
              for title, number in features:
                f.write(f"{title} #{number}\n")
            else:
              f.write("æ— åŠŸèƒ½æ›´æ”¹\n")
          
          # è®¾ç½®releaseæ ‡é¢˜
          today = datetime.datetime.now().strftime('%Y.%m.%d')
          release_title = f"{today}_{os.environ.get('VERSION')}"
          print(f"RELEASE_TITLE={release_title}")
          EOF
          
          cat changelog.md

      - name: åˆ›å»ºRelease
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ env.RELEASE_TITLE }}
          name: ${{ env.RELEASE_TITLE }}
          bodyFile: "changelog.md"
          draft: false
          artifacts: "update_pack.zip"
          token: ${{ secrets.GITHUB_TOKEN }}
        env:
          VERSION: ${{ github.event.inputs.version }}