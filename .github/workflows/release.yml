name: Auto Release Pipeline

on:
  workflow_dispatch:

jobs:
  build-release:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Clean plugins directory
      run: |
        find ./plugins -type f -not \( -name "*.yml" -o -name "*.conf" -o -name "*.txt" -o -name "*.jar" \) -delete

    - name: Package release
      run: |
        sudo apt-get update && sudo apt-get install -y zip
        zip -r release.zip .

    - name: Get previous release date
      id: previous-release
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        latest_date=$(gh api repos/${{ github.repository }}/releases/latest --jq '.created_at' 2>/dev/null || true)
        echo "date=${latest_date:-1970-01-01T00:00:00Z}" >> $GITHUB_OUTPUT

    - name: Generate changelog
      id: changelog
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        issues=$(gh api "repos/${{ github.repository }}/issues?state=closed&since=${{ steps.previous-release.outputs.date }}" |
          jq -r '.[] | select(.labels[]?.name != "Closed as not planned") | "ä¿®å¤äº†\(.title)çš„é—®é¢˜"')
        
        if [ -z "$issues" ]; then
          issues="æœ¬æ¬¡æ›´æ–°åŒ…å«å¸¸è§„ç»´æŠ¤å’Œä¼˜åŒ–"
        fi
        
        delimiter=$(openssl rand -hex 16)
        echo "log<<$delimiter" >> $GITHUB_OUTPUT
        echo "$issues" >> $GITHUB_OUTPUT
        echo "$delimiter" >> $GITHUB_OUTPUT

    - name: Create release
      uses: softprops/action-gh-release@v1
      with:
        name: $(date +'%Y.%m')
        body: |
          ğŸ“¦ æ›´æ–°å†…å®¹ï¼š
          ${{ steps.changelog.outputs.log }}
        files: release.zip