name: Create Release with Changelog

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·'
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥ä¾¿æ­£ç¡®å¤„ç†issues

      # 2. æ›¿æ¢ç‰ˆæœ¬å·
      - name: Update version in files
        run: |
          # æ›¿æ¢globalscoreboard.ymlä¸­çš„ç‰ˆæœ¬å·
          if [ -f "./plugins/AnimatedScoreboard/scoreboards/globalscoreboard.yml" ]; then
            sed -i "s/%server_version%/${{ github.event.inputs.version }}/g" "./plugins/AnimatedScoreboard/scoreboards/globalscoreboard.yml"
          fi
          
          # æ›¿æ¢globalnoseason.ymlä¸­çš„ç‰ˆæœ¬å·
          if [ -f "./plugins/AnimatedScoreboard/scoreboards/globalnoseason.yml" ]; then
            sed -i "s/%server_version%/${{ github.event.inputs.version }}/g" "./plugins/AnimatedScoreboard/scoreboards/globalnoseason.yml"
          fi

      # 3. æ¸…ç†pluginsç›®å½• - åªä¿ç•™.yml,.conf,.txt,.jaræ–‡ä»¶å’Œæ‰€æœ‰æ–‡ä»¶å¤¹ç»“æ„
      - name: Clean plugins directory
        run: |
          if [ -d "./plugins" ]; then
            find ./plugins -type f -not \( -name "*.yml" -o -name "*.conf" -o -name "*.txt" -o -name "*.jar" \) -delete
          fi

      # 4. æ‰“åŒ…æ–‡ä»¶
      - name: Create update package
        run: |
          # å®‰è£…7z
          sudo apt-get update
          sudo apt-get install -y p7zip-full
          
          # åˆ›å»ºæ’é™¤æ–‡ä»¶åˆ—è¡¨
          echo "README.md" > exclude.txt
          echo ".github/" >> exclude.txt
          echo ".git/" >> exclude.txt
          echo ".gitattributes" >> exclude.txt
          echo "manual.txt" >> exclude.txt
          echo "exclude.txt" >> exclude.txt  # ç¡®ä¿exclude.txtè‡ªèº«ä¹Ÿè¢«æ’é™¤
          
          # ä½¿ç”¨7zåˆ›å»ºå‹ç¼©åŒ…ï¼Œä½¿ç”¨æœ€é«˜å‹ç¼©çº§åˆ«
          7z a -t7z -mx=9 -xr@exclude.txt update_pack.7z ./

      # 5. ç”Ÿæˆæ›´æ–°æ—¥å¿—
      - name: Generate changelog
        id: changelog
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // è·å–æœ€æ–°çš„release
            let latestReleaseDate = null;
            try {
              const latestRelease = await github.rest.repos.getLatestRelease({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              latestReleaseDate = new Date(latestRelease.data.created_at);
              console.log(`Latest release date: ${latestReleaseDate.toISOString()}`);
            } catch (error) {
              console.log("No previous releases found, will include all issues");
            }
            
            // ä½¿ç”¨GraphQL APIæŸ¥è¯¢issues (æ›¿ä»£å·²å¼ƒç”¨çš„search/issues endpoint)
            const query = `
              query($owner:String!, $repo:String!, $states:[IssueState!]) {
                repository(owner:$owner, name:$repo) {
                  issues(states:$states, first:100, orderBy:{field:CREATED_AT, direction:DESC}) {
                    nodes {
                      number
                      title
                      state
                      closedAt
                      labels(first:10) {
                        nodes {
                          name
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            const variables = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              states: ["CLOSED"]
            };
            
            const result = await github.graphql(query, variables);
            
            // å¤„ç†æŸ¥è¯¢ç»“æœ
            const issues = result.repository.issues.nodes
              .filter(issue => {
                // åªåŒ…æ‹¬è‡ªä¸Šæ¬¡å‘å¸ƒåå…³é—­çš„issues
                if (latestReleaseDate && new Date(issue.closedAt) <= latestReleaseDate) {
                  return false;
                }
                
                // æ’é™¤å¸¦æœ‰wontfixæˆ–invalidæ ‡ç­¾çš„issues
                const labels = issue.labels.nodes.map(label => label.name.toLowerCase());
                return !labels.includes('wontfix') && !labels.includes('invalid');
              });
            
            // åˆ†ç±»issues
            const bugfixes = [];
            const features = [];
            
            for (const issue of issues) {
              const title = issue.title
                .replace('[Bug]: ', '')
                .replace('[Bug]:', '')
                .replace('[Feature request]: ', '')
                .replace('[Feature request]:', '')
                .trim();
                
              if (issue.title.toLowerCase().includes('[bug]')) {
                bugfixes.push({ title, number: issue.number });
              } else if (issue.title.toLowerCase().includes('[feature')) {
                features.push({ title, number: issue.number });
              }
            }
            
            // è¯»å–manual.txt
            let manualContent = '';
            try {
              if (fs.existsSync('manual.txt')) {
                manualContent = fs.readFileSync('manual.txt', 'utf8');
              }
            } catch (error) {
              console.log('No manual.txt found or error reading it:', error);
            }
            
            // ç”Ÿæˆchangelogå†…å®¹
            let changelog = '# ğŸ“¦ æ›´æ–°å†…å®¹ï¼š\n\n';
            
            // æ‰‹åŠ¨æ›´æ”¹éƒ¨åˆ†
            changelog += '## éIssuesæ›´æ”¹\n';
            if (manualContent) {
              changelog += manualContent + '\n\n';
            } else {
              changelog += 'æ— \n\n';
            }
            
            // Bugä¿®å¤éƒ¨åˆ†
            changelog += '## Bugä¿®å¤\n';
            if (bugfixes.length > 0) {
              for (const bug of bugfixes) {
                changelog += `ä¿®å¤äº†${bug.title}çš„é—®é¢˜ #${bug.number}\n`;
              }
            } else {
              changelog += 'æ— \n';
            }
            changelog += '\n';
            
            // åŠŸèƒ½æ›´æ”¹éƒ¨åˆ†
            changelog += '## åŠŸèƒ½æ›´æ”¹\n';
            if (features.length > 0) {
              for (const feature of features) {
                changelog += `${feature.title} #${feature.number}\n`;
              }
            } else {
              changelog += 'æ— \n';
            }
            
            // ä¿å­˜åˆ°æ–‡ä»¶
            fs.writeFileSync('CHANGELOG.md', changelog);
            
            return changelog;

      # 6. åˆ›å»ºrelease
      - name: Create Release
        id: create_release
        run: |
          # è·å–ä»Šå¤©çš„æ—¥æœŸ(æ ¼å¼ä¸ºyyyy.mm.dd)
          TODAY=$(date +'%Y.%m.%d')
          # ç”Ÿæˆreleaseæ ‡ç­¾
          RELEASE_TAG="${TODAY}_${{ github.event.inputs.version }}"
          echo "RELEASE_TAG=${RELEASE_TAG}" >> $GITHUB_ENV
      - name: Upload Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_TAG }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: false
          files: |
            update_pack.7z