name: Create Release

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å†™å…¥æƒé™æ¥åˆ›å»ºrelease
      issues: read     # éœ€è¦è¯»å–æƒé™æ¥èŽ·å–issuesä¿¡æ¯
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²è®°å½•
      
      - name: Delete unwanted files in plugins folder
        run: |
          # åˆ é™¤pluginsæ–‡ä»¶å¤¹ä¸‹é™¤äº†.yml,.conf,.txt,.jarçš„æ‰€æœ‰æ–‡ä»¶ï¼Œä½†ä¿ç•™æ–‡ä»¶å¤¹ç»“æž„
          find ./plugins -type f -not -name "*.yml" -not -name "*.conf" -not -name "*.txt" -not -name "*.jar" -delete
      
      - name: Create release.zip
        run: |
          # æ‰“åŒ…é™¤README.mdï¼Œ.githubï¼Œ.gitattributeså¤–çš„æ‰€æœ‰æ–‡ä»¶ä¸ºrelease.zip
          zip -r release.zip . -x "README.md" ".github/*" ".gitattributes" "*.git*"
      
      - name: Get latest release date
        id: latest_release
        run: |
          # èŽ·å–æœ€æ–°releaseçš„å‘å¸ƒæ—¥æœŸï¼Œå¦‚æžœæ²¡æœ‰åˆ™ä½¿ç”¨ä»“åº“åˆ›å»ºæ—¥æœŸ
          latest_release_date=$(gh api repos/${{ github.repository }}/releases/latest --jq '.published_at' 2>/dev/null || echo "")
          if [ -z "$latest_release_date" ]; then
            echo "No previous release found, using repository creation date"
            latest_release_date=$(gh api repos/${{ github.repository }} --jq '.created_at')
          fi
          echo "latest_release_date=$latest_release_date" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Generate changelog
        id: changelog
        run: |
          # èŽ·å–ä¸Šæ¬¡å‘å¸ƒä»¥æ¥çš„æ‰€æœ‰å·²å®Œæˆçš„issues
          issues=$(gh api graphql -f query='
            query($repo_owner:String!, $repo_name:String!, $since:DateTime!) {
              repository(owner: $repo_owner, name: $repo_name) {
                issues(states: CLOSED, filterBy: {since: $since}) {
                  nodes {
                    number
                    title
                    labels(first: 10) {
                      nodes {
                        name
                      }
                    }
                    closedAt
                    closedStateReason
                  }
                }
              }
            }' -f repo_owner=${{ github.repository_owner }} -f repo_name=$(echo "${{ github.repository }}" | cut -d'/' -f2) -f since="${{ steps.latest_release.outputs.latest_release_date }}")
          
          # å‡†å¤‡changelog
          echo "# ðŸ“¦ æ›´æ–°å†…å®¹ï¼š" > changelog.md
          echo "" >> changelog.md
          
          # å¤„ç†Bugä¿®å¤
          echo "## Bugä¿®å¤" >> changelog.md
          
          # ä½¿ç”¨Pythonå¤„ç†JSONæ•°æ®
          python3 -c '
          import json, sys
          data = json.loads(sys.argv[1])
          bug_count = 0
          
          for issue in data["data"]["repository"]["issues"]["nodes"]:
              # è·³è¿‡æ ‡è®°ä¸ºNOT_PLANNEDçš„issues
              if issue.get("closedStateReason") == "NOT_PLANNED":
                  continue
                  
              # æ£€æŸ¥æ˜¯å¦æœ‰bugæ ‡ç­¾
              has_bug_label = False
              for label in issue["labels"]["nodes"]:
                  if "bug" in label["name"].lower():
                      has_bug_label = True
                      break
                      
              if has_bug_label:
                  print(f"ä¿®å¤äº†{issue[\"title\"]}çš„é—®é¢˜ #{issue[\"number\"]}")
                  bug_count += 1
          
          if bug_count == 0:
              print("")
          ' "$issues" >> changelog.md
          
          echo "" >> changelog.md
          
          # å¤„ç†åŠŸèƒ½æ›´æ”¹
          echo "## åŠŸèƒ½æ›´æ”¹" >> changelog.md
          
          python3 -c '
          import json, sys
          data = json.loads(sys.argv[1])
          feature_count = 0
          
          for issue in data["data"]["repository"]["issues"]["nodes"]:
              # è·³è¿‡æ ‡è®°ä¸ºNOT_PLANNEDçš„issues
              if issue.get("closedStateReason") == "NOT_PLANNED":
                  continue
                  
              # æ£€æŸ¥æ˜¯å¦æœ‰åŠŸèƒ½ç›¸å…³æ ‡ç­¾
              has_feature_label = False
              for label in issue["labels"]["nodes"]:
                  if "enhancement" in label["name"].lower() or "feature" in label["name"].lower():
                      has_feature_label = True
                      break
                      
              if has_feature_label:
                  print(f"{issue[\"title\"]} #{issue[\"number\"]}")
                  feature_count += 1
          
          if feature_count == 0:
              print("")
          ' "$issues" >> changelog.md
          
          cat changelog.md
          
          # å°†changelogå†…å®¹è®¾ç½®ä¸ºè¾“å‡º
          changelog_content=$(cat changelog.md)
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$changelog_content" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Generate release date
        id: date
        run: echo "release_date=$(date +'%Y.%m.%d')" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ steps.date.outputs.release_date }}
          tag_name: ${{ steps.date.outputs.release_date }}
          body: ${{ steps.changelog.outputs.content }}
          files: release.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}