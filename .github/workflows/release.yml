name: Auto Release Pipeline

on:
  workflow_dispatch:

jobs:
  build-release:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Clean plugins directory
      run: |
        find ./plugins -type f -not \( -name "*.yml" -o -name "*.conf" -o -name "*.txt" -o -name "*.jar" \) -delete

    - name: Package release
      run: |
        sudo apt-get install -y zip
        zip -r release.zip . -x ".git/*"

    - name: Get previous release date
      id: previous-release
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        if ! gh release view latest &>/dev/null; then
          echo "date=1970-01-01T00:00:00Z" >> $GITHUB_OUTPUT
          exit 0
        fi
        latest_date=$(gh api repos/${{ github.repository }}/releases/latest --jq '.created_at')
        echo "date=${latest_date}" >> $GITHUB_OUTPUT

    - name: Generate changelog
      id: changelog
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # è°ƒè¯•ä¿¡æ¯è¾“å‡º
        echo "å‰æ¬¡å‘å¸ƒæ—¥æœŸ: ${{ steps.previous-release.outputs.date }}"
        
        # è½¬æ¢æ—¥æœŸæ ¼å¼å¹¶ç¼–ç 
        encoded_date=$(echo "${{ steps.previous-release.outputs.date }}" | jq -sRr @uri)
        echo "ç¼–ç åçš„æ—¥æœŸå‚æ•°: $encoded_date"

        # æ‰§è¡ŒAPIè¯·æ±‚
        api_url="repos/${{ github.repository }}/issues?state=closed&since=$encoded_date"
        echo "è¯·æ±‚URL: $api_url"
        
        # è·å–å¹¶å¤„ç†issuesæ•°æ®
        issues=$(gh api "$api_url" \
          --jq '[.[] | select(.state == "closed" and (any(.labels[]?; .name != "Closed as not planned"))]')
        
        # è°ƒè¯•è¾“å‡ºåŸå§‹æ•°æ®
        echo "åŸå§‹issuesæ•°æ®: $issues"
        
        # æ„å»ºå˜æ›´æ—¥å¿—
        changelog_content="ğŸ“¦ æ›´æ–°å†…å®¹ï¼š\n"
        issue_count=$(echo "$issues" | jq 'length')
        
        if [ $issue_count -gt 0 ]; then
          echo "å‘ç° $issue_count ä¸ªæœ‰æ•ˆissue"
          echo "$issues" | jq -r '.[] | "â€¢ ä¿®å¤äº†ã€Œ\(.title)ã€çš„é—®é¢˜"' | while read line; do
            changelog_content+="${line}\n"
          done
        else
          echo "æœªæ‰¾åˆ°æœ‰æ•ˆissueï¼Œä½¿ç”¨é»˜è®¤ä¿¡æ¯"
          changelog_content+="â€¢ æœ¬æ¬¡æ›´æ–°åŒ…å«å¸¸è§„ç»´æŠ¤å’Œä¼˜åŒ–"
        fi

        # æ ¼å¼åŒ–è¾“å‡º
        changelog_content=$(echo -e "$changelog_content")
        echo "ç”Ÿæˆçš„æ›´æ–°å†…å®¹ï¼š"
        echo "$changelog_content"

        # è¾“å‡ºåˆ°ç¯å¢ƒå˜é‡
        delimiter=$(openssl rand -hex 16)
        echo "log<<${delimiter}" >> $GITHUB_OUTPUT
        echo "$changelog_content" >> $GITHUB_OUTPUT
        echo "${delimiter}" >> $GITHUB_OUTPUT

    - name: Create Git tag
      id: create-tag
      run: |
        # ç”Ÿæˆè§„èŒƒçš„æ ‡ç­¾åç§°ï¼ˆç¤ºä¾‹ï¼šv2024.06.25ï¼‰
        DATE_TAG=$(date +'v%Y.%m.%d')
        
        # æ¸…ç†å¯èƒ½å­˜åœ¨çš„éæ³•å­—ç¬¦
        CLEAN_TAG=$(echo "$DATE_TAG" | tr -cd '[:alnum:]._-')
        
        # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å­˜åœ¨
        if git rev-parse "$CLEAN_TAG" >/dev/null 2>&1; then
          echo "åˆ é™¤å·²å­˜åœ¨çš„æ—§æ ‡ç­¾: $CLEAN_TAG"
          git tag -d "$CLEAN_TAG"
          git push origin ":refs/tags/$CLEAN_TAG" || true
        fi

        # é…ç½®Gitèº«ä»½
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

        # åˆ›å»ºå¸¦æ³¨é‡Šçš„æ ‡ç­¾
        git tag -a "$CLEAN_TAG" -m "è‡ªåŠ¨å‘å¸ƒç‰ˆæœ¬ $CLEAN_TAG"

        # æ¨é€æ ‡ç­¾åˆ°è¿œç¨‹
        git push origin "$CLEAN_TAG"

        # è¾“å‡ºæ ‡ç­¾åç§°
        echo "tag=$CLEAN_TAG" >> $GITHUB_OUTPUT

    - name: Create release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.create-tag.outputs.tag }}
        name: ${{ steps.create-tag.outputs.tag }}
        body: |
          ${{ steps.changelog.outputs.log }}
        files: release.zip