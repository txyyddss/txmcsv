name: Create Release

on:
  workflow_dispatch:
  push:
    tags:
      - '*'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Delete unwanted files in plugins folder
        run: |
          find ./plugins -type f -not -name "*.yml" -not -name "*.conf" -not -name "*.txt" -not -name "*.jar" -delete
      
      - name: Create release.zip
        run: |
          zip -r release.zip . -x "README.md" ".github/*" ".gitattributes" "*.git*"
      
      - name: Get latest release date
        id: latest_release
        run: |
          latest_release_date=$(gh api repos/${{ github.repository }}/releases/latest --jq '.published_at' 2>/dev/null || echo "")
          if [ -z "$latest_release_date" ]; then
            echo "No previous release found, using repository creation date"
            latest_release_date=$(gh api repos/${{ github.repository }} --jq '.created_at')
          fi
          echo "latest_release_date=$latest_release_date" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Generate changelog
        id: changelog
        run: |
          # å°†GraphQLæŸ¥è¯¢ä¿å­˜åˆ°æ–‡ä»¶ä¸­ï¼Œé¿å…YAMLæ ¼å¼é—®é¢˜
          cat > query.graphql << 'EOL'
          query($repo_owner: String!, $repo_name: String!, $since: DateTime!) {
            repository(owner: $repo_owner, name: $repo_name) {
              issues(first: 100, states: CLOSED, filterBy: {since: $since}) {
                nodes {
                  number
                  title
                  labels(first: 10) {
                    nodes {
                      name
                    }
                  }
                  closedAt
                  stateReason
                }
              }
            }
          }
          EOL
          
          # æ‰§è¡ŒGraphQLæŸ¥è¯¢
          issues=$(gh api graphql -F query=@query.graphql -f repo_owner=${{ github.repository_owner }} -f repo_name=$(echo "${{ github.repository }}" | cut -d'/' -f2) -f since="${{ steps.latest_release.outputs.latest_release_date }}")
          
          # å‡†å¤‡changelog
          echo "# ðŸ“¦ æ›´æ–°å†…å®¹ï¼š" > changelog.md
          echo "" >> changelog.md
          
          # å¤„ç†Bugä¿®å¤
          echo "## Bugä¿®å¤" >> changelog.md
          
          # å°†Pythonè„šæœ¬ä¿å­˜åˆ°æ–‡ä»¶ä¸­ï¼Œé¿å…YAMLä¸­çš„è½¬ä¹‰é—®é¢˜
          cat > process_bugs.py << 'EOL'
import json
import sys

data = json.loads(sys.argv[1])
bug_count = 0

for issue in data["data"]["repository"]["issues"]["nodes"]:
    # è·³è¿‡æ ‡è®°ä¸ºNOT_PLANNEDçš„issues
    if issue.get("stateReason") == "NOT_PLANNED":
        continue
        
    # æ£€æŸ¥æ˜¯å¦æœ‰bugæ ‡ç­¾
    has_bug_label = False
    for label in issue["labels"]["nodes"]:
        if "bug" in label["name"].lower():
            has_bug_label = True
            break
            
    if has_bug_label:
        print("ä¿®å¤äº†{}çš„é—®é¢˜ #{}".format(issue["title"], issue["number"]))
        bug_count += 1

if bug_count == 0:
    print("")
EOL
          
          # æ‰§è¡ŒPythonè„šæœ¬å¤„ç†Bug
          python3 process_bugs.py "$issues" >> changelog.md
          
          echo "" >> changelog.md
          
          # å¤„ç†åŠŸèƒ½æ›´æ”¹
          echo "## åŠŸèƒ½æ›´æ”¹" >> changelog.md
          
          # å°†Pythonè„šæœ¬ä¿å­˜åˆ°æ–‡ä»¶ä¸­ï¼Œé¿å…YAMLä¸­çš„è½¬ä¹‰é—®é¢˜
          cat > process_features.py << 'EOL'
import json
import sys

data = json.loads(sys.argv[1])
feature_count = 0

for issue in data["data"]["repository"]["issues"]["nodes"]:
    # è·³è¿‡æ ‡è®°ä¸ºNOT_PLANNEDçš„issues
    if issue.get("stateReason") == "NOT_PLANNED":
        continue
        
    # æ£€æŸ¥æ˜¯å¦æœ‰åŠŸèƒ½ç›¸å…³æ ‡ç­¾
    has_feature_label = False
    for label in issue["labels"]["nodes"]:
        if "enhancement" in label["name"].lower() or "feature" in label["name"].lower():
            has_feature_label = True
            break
            
    if has_feature_label:
        print("{} #{}".format(issue["title"], issue["number"]))
        feature_count += 1

if feature_count == 0:
    print("")
EOL
          
          # æ‰§è¡ŒPythonè„šæœ¬å¤„ç†åŠŸèƒ½
          python3 process_features.py "$issues" >> changelog.md
          
          cat changelog.md
          
          # å°†changelogå†…å®¹è®¾ç½®ä¸ºè¾“å‡º
          changelog_content=$(cat changelog.md)
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$changelog_content" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Generate release date
        id: date
        run: echo "release_date=$(date +'%Y.%m.%d')" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ steps.date.outputs.release_date }}
          tag_name: ${{ steps.date.outputs.release_date }}
          body: ${{ steps.changelog.outputs.content }}
          files: release.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}