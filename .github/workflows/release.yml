name: Create Release

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€å¸¦vå‰ç¼€çš„tagæ—¶è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ä»¥ä¾¿èŽ·å–æ‰€æœ‰issues
      
      - name: Clean plugins directory
        run: |
          if [ -d "./plugins" ]; then
            find ./plugins -type f -not \( -name "*.yml" -o -name "*.conf" -o -name "*.txt" -o -name "*.jar" \) -delete
          else
            echo "Plugins directory not found, skipping cleanup."
          fi
      
      - name: Create release.zip
        run: |
          zip -r release.zip . -x "README.md" ".github/*" ".gitattributes"
      
      - name: Generate changelog and release tag
        id: changelog
        uses: actions/github-script@v6
        with:
          script: |
            const today = new Date();
            const releaseTag = `${today.getFullYear()}.${String(today.getMonth() + 1).padStart(2, '0')}.${String(today.getDate()).padStart(2, '0')}`;
            core.exportVariable('RELEASE_TAG', releaseTag);
            
            // èŽ·å–æœ€æ–°releaseçš„æ—¥æœŸ
            let lastReleaseDate = null;
            try {
              const { data: releases } = await github.rest.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 1
              });
              
              if (releases.length > 0) {
                lastReleaseDate = new Date(releases[0].published_at);
                console.log(`Last release date: ${lastReleaseDate.toISOString()}`);
              }
            } catch (error) {
              console.log("No previous releases found or error occurred:", error);
            }
            
            // èŽ·å–æ‰€æœ‰å·²å…³é—­çš„issues
            const allIssues = [];
            let page = 1;
            let hasMoreIssues = true;
            
            while (hasMoreIssues) await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'closed',
                per_page: 100,
                page: page
              });
              
              if (issues.length === 0) {
                hasMoreIssues = false;
              } else {
                // è¿‡æ»¤issuesï¼š
                // 1. ä¸æ˜¯PR
                // 2. æ²¡æœ‰wontfixæ ‡ç­¾
                // 3. å¦‚æžœæœ‰lastReleaseDateï¼Œåˆ™åªèŽ·å–åœ¨è¯¥æ—¥æœŸä¹‹åŽå…³é—­çš„issues
                const filteredIssues = issues.filter(issue => {
                  if (issue.pull_request) return false;
                  if (issue.labels.some(label => label.name.toLowerCase() === 'wontfix')) return false;
                  if (lastReleaseDate && new Date(issue.closed_at) <= lastReleaseDate) return false;
                  return true;
                });
                
                allIssues.push(...filteredIssues);
                page++;
              }
            }
            
            console.log(`Found ${allIssues.length} relevant issues`);
            
            // åˆ†ç±»issues
            const bugs = [];
            const features = [];
            
            for (const issue of allIssues) {
              // æ£€æŸ¥issueæ˜¯å¦ä¸ºbug
              const isBug = issue.labels.some(label => 
                label.name.toLowerCase().includes('bug') || 
                label.name.toLowerCase().includes('ä¿®å¤') || 
                label.name.toLowerCase().includes('fix')
              );
              
              if (isBug) {
                bugs.push(issue);
              } else {
                features.push(issue);
              }
            }
            
            console.log(`Bugs: ${bugs.length}, Features: ${features.length}`);
            
            // ç”Ÿæˆchangelog
            let changelog = "# ðŸ“¦ æ›´æ–°å†…å®¹ï¼š\n";
            
            changelog += "\n## Bugä¿®å¤\n";
            if (bugs.length > 0) {
              for (const bug of bugs) {
                changelog += `ä¿®å¤äº†${bug.title}çš„é—®é¢˜ #${bug.number}\n`;
              }
            }
            
            changelog += "\n## åŠŸèƒ½æ›´æ”¹\n";
            if (features.length > 0) {
              for (const feature of features) {
                changelog += `${feature.title} #${feature.number}\n`;
              }
            }
            
            // è¾“å‡ºchangelog
            core.setOutput('changelog', changelog);
            fs.writeFileSync('CHANGELOG.md', changelog);
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_TAG }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: false
          files: |
            release.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
